rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Profiles / users
    match /profiles/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null &&
                   (request.auth.uid == userId || isAdmin());
      allow delete: if request.auth != null && isAdmin();
    }

    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null && request.auth.uid == userId;
      allow update: if request.auth != null &&
                    (request.auth.uid == userId || isAdmin());
      allow delete: if request.auth != null && isAdmin();
    }

    // Admins
    match /admins/{adminId} {
      allow read, write: if request.auth != null && isAdmin();
    }

    // Hospitals
    match /hospitals/{hospitalId} {
      allow read, create: if request.auth != null;
      allow update: if request.auth != null &&
        (isAdmin() || request.auth.token.email == resource.data.email);
      allow delete: if request.auth != null && isAdmin();
    }

    // Blood inventory
    match /blood_inventory/{inventoryId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Donation requests (web + app)
    match /donation_requests/{requestId} {
      allow read: if request.auth != null;
      allow create, update, delete: if request.auth != null && (
        isAdmin() ||
        (request.resource.data.hospitalId == request.auth.uid) ||
        (resource != null && resource.data.hospitalId == request.auth.uid)
      );
    }

    // Feed + detail collections powering the app request cards
    match /blood_requests_feed/{feedId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    match /blood_request_details/{detailId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Notifications
    match /notifications/{notificationId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null && isAdmin();
    }

    // Per-user notifications
    match /userNotifications/{notificationId} {
      allow read: if request.auth != null &&
                  (resource == null || resource.data.userId == request.auth.uid || isAdmin());
      allow create: if request.auth != null && isAdmin();
      allow update: if request.auth != null &&
                    (isAdmin() ||
                     (resource != null && resource.data.userId == request.auth.uid));
      allow delete: if request.auth != null && 
                    (isAdmin() || (resource != null && resource.data.userId == request.auth.uid));
    }

    // Donation history
    match /donations/{donationId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }
  }
}
